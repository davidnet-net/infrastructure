---
# Traefik CRDs via Helm
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: traefik-crd
  namespace: kube-system
spec:
  chart: https://%{KUBERNETES_API}%/static/charts/traefik-crd-34.2.1+up34.2.0.tgz
---
# Traefik Helm chart installation
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: traefik
  namespace: kube-system
spec:
  chart: https://%{KUBERNETES_API}%/static/charts/traefik-34.2.1+up34.2.0.tgz
  set:
    global.systemDefaultRegistry: ""
  valuesContent: |-
    deployment:
      podAnnotations:
        prometheus.io/port: "8082"
        prometheus.io/scrape: "true"

    providers:
      kubernetesIngress:
        publishedService:
          enabled: true

    priorityClassName: "system-cluster-critical"

    image:
      repository: "rancher/mirrored-library-traefik"
      tag: "3.3.6"

    tolerations:
    - key: "CriticalAddonsOnly"
      operator: "Exists"
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"

    service:
      ipFamilyPolicy: "PreferDualStack"

    # Automatic HTTPS with Let's Encrypt for external domains
    ingressRoute:
      dashboard:
        enabled: false

    certificatesResolvers:
      letsencrypt:
        acme:
          email: "contact@davidnet.net"
          storage: "/data/acme.json"
          httpChallenge:
            entryPoint: "web"

    entryPoints:
      web:
        address: ":80"
      websecure:
        address: ":443"

---
# Service representing your external proxy at 192.168.1.126
apiVersion: v1
kind: Service
metadata:
  name: old-proxy
  namespace: kube-system
spec:
  ports:
    - name: http
      port: 80
      targetPort: 80
    - name: https
      port: 443
      targetPort: 443
---
# Endpoints for the Service pointing to external IP
apiVersion: v1
kind: Endpoints
metadata:
  name: old-proxy
  namespace: kube-system
subsets:
  - addresses:
      - ip: 192.168.1.126
    ports:
      - port: 80
        name: http
      - port: 443
        name: https
---
# Catch-all router in Traefik forwarding everything to the external proxy
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: catch-all
  namespace: kube-system
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: HostRegexp(`{host:.+}`)
      kind: Rule
      services:
        - name: old-proxy
          port: 80
